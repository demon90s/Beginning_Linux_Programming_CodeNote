<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>套接字3 - Linux程序设计学习笔记</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">Linux程序设计学习笔记</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">Home</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Chapters <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../ch01%20%E5%85%A5%E9%97%A8/">ch01 入门</a>
</li>
                            
<li >
    <a href="../ch02%20shell%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">ch02 shell程序设计</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">ch03 文件操作</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../ch03%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C_1/">文件操作1</a>
</li>
            
<li >
    <a href="../ch03%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C_2/">文件操作2</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../ch08%20MySQL/">ch08 MySQL</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">ch15 套接字</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../ch15%20%E5%A5%97%E6%8E%A5%E5%AD%97_1/">套接字1</a>
</li>
            
<li >
    <a href="../ch15%20%E5%A5%97%E6%8E%A5%E5%AD%97_2/">套接字2</a>
</li>
            
<li class="active">
    <a href="./">套接字3</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../ch15%20%E5%A5%97%E6%8E%A5%E5%AD%97_2/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="disabled">
                        <a rel="prev" >
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/demon90s/Beginning_Linux_Programming_CodeNote">
                                <i class="fa fa-github"></i>GitHub
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#_1">多客户</a></li>
            <li><a href="#select">select系统调用</a></li>
            <li><a href="#_2">多客户</a></li>
        <li class="main "><a href="#_3">数据报</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="_1">多客户</h1>
<p>考虑有多个客户同时连接一个服务器的情况。服务器程序在接受来自客户的一个新连接时，会创建出一个新的套接字，而原先的监听套接字将被保留以继续监听以后的连接。如果服务器不能立刻接受后来的连接，它们将被放到队列中以等待处理。</p>
<p>原先的套接字仍然可用并且套接字的行为就像文件描述符，这一事实给我们提供了一种同时服务多个客户的方法。如果服务器调用fork为自己创建第二份副本，打开的新套接字就将被新的子进程所继承。新的子进程可以和连接的客户进行通信，而主服务器进程可以继续接受以后的客户连接。</p>
<p>由于我们创建子进程，但并不等待它们完成，所以必须安排服务器忽略SIGCHLD信号以避免出现僵尸进程。</p>
<blockquote>
<p>个人理解：这里所说的方法即是：每当接受（accept）队列中一个连接后，就fork一个子进程，由子进程使用新获得的sockfd和客户通信。而父进程继续处理以后的客户连接。</p>
</blockquote>
<p>事例代码见example4。</p>
<h2 id="select">select系统调用</h2>
<p>select系统调用允许程序同时在多个底层文件描述符上等待输入的到达（或输出的完成）。这意味着终端仿真程序可以一直阻塞到有事情可做为止。类似地，服务器也可以通过同时在多个打开的套接字上等待请求到来的方法来处理多个客户。</p>
<p>select函数对数据结构fd_set进行操作，它是由打开的文件描述符构成的集合。有一组定义好的宏可以用来控制这些集合：</p>
<pre><code>#include &lt;sys/time.h&gt;
#include &lt;sys/types.h&gt;

void FD_CLR(int fd, fd_set *set);
int  FD_ISSET(int fd, fd_set *set);
void FD_SET(int fd, fd_set *set);
void FD_ZERO(fd_set *set);
</code></pre>

<p>FD_ZERO用于将fd_set初始化为空集合，FD_SET和FD_CLR分别用于在集合中设置和清除由参数fd传递的文件描述符。如果FD_ISSET宏中由参数fd指向的文件描述符是由参数fdset指向的fd_set集合中的一个元素，FD_ISSET将返回非零值。</p>
<p>fd_set结构中可以容纳的文件描述符的最大数目由常量FD_SETSIZE指定。</p>
<p>select函数用一个超时值来防止无限期的阻塞，这个超时值由一个timeval结构给出。</p>
<pre><code>struct timeval {
    long    tv_sec;         /* seconds */
    long    tv_usec;        /* microseconds */
};
</code></pre>

<p>select系统调用的原型如下：</p>
<pre><code>#include &lt;sys/time.h&gt;
#include &lt;sys/types.h&gt;

int select(int nfds, fd_set *readfds, fd_set *writefds,
                  fd_set *exceptfds, struct timeval *timeout);
</code></pre>

<p>select调用用于测试文件描述符集合中，是否有一个文件描述符已处于可读状态或可写状态或错误状态，它将阻塞以等待某个文件描述符进入这些状态。</p>
<p>参数nfds指定需要测试的文件描述符数目，测试的描述符范围从0到nfds-1。3个描述符集合都可以被设置为空指针，这表示不执行相应的测试。</p>
<p>select函数会在发生以下情况时返回：readfds中有描述符可读、writefds中有描述符可写或errorfds中有描述符遇到错误条件。如果这3种情况都没有发生，select将在timeout指定的超时时间经过后返回，如果timeout是一个空指针，这个调用会一直阻塞下去。</p>
<p>当select返回时，描述符集合将被修改以指示哪些描述符正处于可读、可写或有错误的状态。可以使用FD_ISSET对描述符进行测试，来找出需要注意的描述符。</p>
<p>select调用返回状态发生变化的描述符总数。失败时它将返回-1并设置errno。timeout参数指向的结构可能还会被修改为剩余的超时时间。</p>
<p>见代码案例：select.c。</p>
<h2 id="_2">多客户</h2>
<p>通过使用select调用来同时处理多个客户就无需依赖于子进程了。但在把这个技巧应用到实际的应用程序中时，必须要注意，不能在处理第一个连接的客户时让其他客户等太长的时间。</p>
<p>服务器可以使用select调用同时检查监听套接字和客户连接的套接字。一旦select调用指示有活动发生，就可以调用FD_ISSET来遍历所有可能的文件描述符，以检查是哪个上面有活动发生。</p>
<p>如果是监听套接字可读，说明正有一个客户试图建立连接，此时就可以调用accept而不必担心其阻塞。如果是客户描述符准备好，说明有一个客户请求需要我们读取和处理。</p>
<p>见代码案例：example5。</p>
<h1 id="_3">数据报</h1>
<p>当客户需要发送一个短小的查询请求给服务器，并且期望接收到一个短小的响应时，我们一般就使用由UDP服务提供的服务。</p>
<p>sendto系统调用从buffer缓冲区中给使用指定套接字地址的目标服务器发送一个数据报。它的原型如下所示：</p>
<pre><code>int sendto(int sockfd, const void *buf, size_t len, int flags,
               const struct sockaddr *dest_addr, socklen_t addrlen);
</code></pre>

<p>在正常应用中，flag参数一般被设置为0。</p>
<p>recvfrom系统调用在套接字上等待从特定地址到来的数据报，并将它放入buffer缓冲区。它的原型如下所示：</p>
<pre><code>ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags,
                 struct sockaddr *src_addr, socklen_t *addrlen);
</code></pre>

<p>同样，在正常应用中，flag参数一般被设置为0。</p>
<p>当错误发生时，sendto和recvfrom都将返回-1并设置errno。</p>
<p>除非用fcntl将套接字设置为非阻塞方式，否则recvfrom调用将一直阻塞。我们可以用与前面的面向连接服务器一样的方式，通过select调用和超时设置来判断是否有数据到达套接字。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
